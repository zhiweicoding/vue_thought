---
title: Redis缓存内容太多了怎么办
icon: circle-info
---
# Redis Cluster 常见问题解析

在高并发场景下，Redis 经常被用作分布式缓存系统。为了提高缓存的可用性和扩展性，Redis 提供了 Redis Cluster 作为分布式缓存的解决方案。本文将针对 Redis Cluster 常见的几个问题进行详细解析，帮助大家深入理解 Redis Cluster 的工作原理和优势。

## 1. 为什么需要 Redis Cluster？

在高并发场景下，使用 Redis 主要会遇到以下两个问题：

1. **缓存的数据量太大**：数据量可能达到数十 GB，甚至是几百 GB 或更大。
2. **并发量要求过高**：尽管 Redis 号称单机可以支持 10 万并发，但实际项目中可能会遇到很多不可靠因素，特别是复杂的读写操作会显著影响并发性能。

### 传统方案的局限性

- **主从复制** 和 **Redis Sentinel**：这两种方案通过增加主库（master）的副本（slave）来提高 Redis 服务的可用性和读吞吐量，但无法解决缓存数据量过大或写压力过大的问题。
- **硬件扩容**：通过提升硬件配置来解决性能瓶颈，然而，硬件的局限性和成本都限制了这种方式的扩展性。

![](https://dzw-1256485110.cos.ap-beijing.myqcloud.com/picgo/202412261613178.png)

### Redis Cluster 解决的问题

Redis Cluster 是通过分片（Sharding）来分配数据，提供水平扩展和高可用性。相比传统的主从复制方案，Redis Cluster 允许动态扩容和缩容，从而有效应对高并发和大数据量缓存需求。

#### 主要优势

- **横向扩展**：可以通过增加 Redis 节点来扩展集群，缓解写压力和存储压力。
- **内置主从复制、故障转移机制**：Redis Cluster 自动进行主从复制，不需要额外部署 Redis Sentinel。
- **高可用性**：支持动态扩容和缩容，能够提供集群级别的高可用服务。

## 2. Redis Cluster 的基本架构

Redis Cluster 需要至少 3 个主节点（master）和 3 个从节点（slave）以保证高可用性。每个主节点都有一个或多个从节点作为副本，用于故障转移和提高读吞吐量。

- **数据分片**：数据会被均匀分布到多个主节点上，保证负载均衡。
- **主从复制**：每个主节点有至少一个从节点，主节点宕机时，从节点自动接管。
- **故障转移**：Redis Cluster 支持自动故障转移机制，保证集群的高可用性。

![image-20241226161537003](https://dzw-1256485110.cos.ap-beijing.myqcloud.com/picgo/202412261615079.png)

## 3. Redis Cluster 是如何分片的？

Redis Cluster 使用 **哈希槽分区** 来进行数据管理。整个 Redis Cluster 会被划分为 16384 个哈希槽，每个键值对会根据其 key 的哈希值被分配到一个哈希槽中。

### 哈希槽的计算方法

1. 对给定的 key 计算 CRC-16 校验码。
2. 对校验码进行取模操作，计算出该 key 对应的哈希槽。

### 哈希槽分配

每个 Redis 节点负责一个或多个哈希槽。例如，一个集群中可能会有 3 个节点，每个节点负责一定范围的哈希槽：

- **Node 1**: 0 - 5500
- **Node 2**: 5501 - 11000
- **Node 3**: 11001 - 16383

客户端通过连接任意一个 Redis 节点，查找 key 对应的哈希槽，并通过哈希槽找到目标节点。

## 4. 为什么 Redis Cluster 的哈希槽是 16384 个？

虽然 CRC-16 校验码可以产生 65536（2^16）个值，但 Redis Cluster 选择了 16384 个哈希槽（2^14）。这是由于以下原因：

- **节省内存**：每个哈希槽的位图（bitmap）大小直接影响节点配置的内存占用，16384 个哈希槽在内存上更具可扩展性。
- **性能优化**：相比 65536 个哈希槽，16384 个哈希槽的位图压缩效果更好，同时也能满足大多数实际需求。

## 5. Redis Cluster 如何重新分配哈希槽？

在 Redis Cluster 中，哈希槽的分配是动态的，支持在集群扩容或缩容时重新分配哈希槽。以下是常用的命令：

- **CLUSTER ADDSLOTS**：将指定的哈希槽分配给当前节点。
- **CLUSTER DELSLOTS**：从当前节点中删除指定的哈希槽。
- **CLUSTER SETSLOT**：迁移哈希槽到其他节点。

## 6. Redis Cluster 扩容和缩容期间如何保证服务可用？

Redis Cluster 在扩容和缩容期间，能够保证集群对外提供服务，具体方式如下：

- **ASK 重定向**：当哈希槽正在迁移时，客户端会收到一个临时的 `ASK` 重定向，客户端会自动重定向请求到新的节点。
- **MOVED 重定向**：当哈希槽迁移完成后，客户端会收到 `MOVED` 错误，客户端会将请求发送到新节点。

这些机制使得扩容和缩容过程对客户端透明，保证了 Redis Cluster 的高可用性。

## 7. Redis Cluster 中的节点如何进行通信？

Redis Cluster 中的节点使用 **Gossip 协议** 来进行通信和状态同步。常见的 Gossip 消息包括：

- **MEET**：用于将新节点加入集群。
- **PING/PONG**：节点之间定时交换状态信息，检查其他节点的可用性。
- **FAIL**：用于标记节点故障，触发故障转移机制。

节点通过 Gossip 协议相互发送状态信息，保证集群的稳定运行。

## 8. 总结

Redis Cluster 提供了高可用、可扩展的分布式缓存解决方案，能够有效应对高并发和大数据量缓存的挑战。其主要特点包括：

- **横向扩展**：支持动态增加或减少节点来应对不断增长的压力。
- **高可用性**：内置主从复制和故障转移机制，保证集群的持续运行。
- **哈希槽分片**：通过哈希槽来进行数据分配，提升了集群的横向扩展性和容错性。

Redis Cluster 的这些优势使其成为大规模应用中缓存系统的首选方案。

## 参考资料

- [Redis Cluster 官方规范](https://redis.io/docs/reference/cluster-spec/)
- [Redis Cluster 官方教程](https://redis.io/topics/cluster-tutorial)
- [Redis 集群详述](https://juejin.cn/post/7016865316240097287)
- [Redis 专题：了解 Redis 集群，这篇就够了](https://juejin.cn/post/6949832776224866340)